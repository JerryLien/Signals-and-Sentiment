services:
  # 爬蟲核心 — 定時爬取 PTT + Reddit 並寫入 InfluxDB
  sentiment-engine:
    build: .
    container_name: sentiment-engine
    volumes:
      - ./data:/app/data
    environment:
      INFLUXDB_URL: http://influxdb:8086
      INFLUXDB_TOKEN: ${INFLUXDB_TOKEN:-ptt-dev-token}
      INFLUXDB_ORG: ${INFLUXDB_ORG:-ptt-lab}
      INFLUXDB_BUCKET: ${INFLUXDB_BUCKET:-ptt_sentiment}
      REDDIT_CLIENT_ID: ${REDDIT_CLIENT_ID:-}
      REDDIT_CLIENT_SECRET: ${REDDIT_CLIENT_SECRET:-}
    depends_on:
      influxdb:
        condition: service_started
    restart: unless-stopped

  # LLM Agent — 異常事件自動歸因 (The "Why" Layer)
  # 偵測到情緒異常時呼叫 LLM 解釋原因，結果標註在 Grafana 時間軸上
  llm-agent:
    build: .
    container_name: llm-agent
    entrypoint: ["python", "-m", "llm_agent.monitor"]
    volumes:
      - ./data:/app/data
    environment:
      INFLUXDB_URL: http://influxdb:8086
      INFLUXDB_TOKEN: ${INFLUXDB_TOKEN:-ptt-dev-token}
      INFLUXDB_ORG: ${INFLUXDB_ORG:-ptt-lab}
      INFLUXDB_BUCKET: ${INFLUXDB_BUCKET:-ptt_sentiment}
      GRAFANA_URL: http://grafana:3000
      GRAFANA_PASSWORD: ${GF_SECURITY_ADMIN_PASSWORD:-admin}
      LLM_PROVIDER: ${LLM_PROVIDER:-anthropic}
      LLM_API_KEY: ${LLM_API_KEY:-}
      LLM_MODEL: ${LLM_MODEL:-}
      LLM_POLL_INTERVAL: ${LLM_POLL_INTERVAL:-300}
    depends_on:
      influxdb:
        condition: service_started
      grafana:
        condition: service_started
    restart: unless-stopped

  # InfluxDB 初始化後設定 Retention Policy
  influxdb-init:
    image: influxdb:2.7
    container_name: influxdb-init
    depends_on:
      influxdb:
        condition: service_started
    environment:
      INFLUXDB_TOKEN: ${INFLUXDB_TOKEN:-ptt-dev-token}
      INFLUXDB_ORG: ${INFLUXDB_ORG:-ptt-lab}
      INFLUXDB_BUCKET: ${INFLUXDB_BUCKET:-ptt_sentiment}
      INFLUXDB_RETENTION_DAYS: ${INFLUXDB_RETENTION_DAYS:-90}
    entrypoint: >
      sh -c '
        echo "Waiting for InfluxDB to start..."
        sleep 5
        RETENTION_SECONDS=$$((INFLUXDB_RETENTION_DAYS * 86400))
        echo "Setting retention policy: $${INFLUXDB_RETENTION_DAYS} days ($${RETENTION_SECONDS}s)"
        influx bucket update
          --host http://influxdb:8086
          --token $$INFLUXDB_TOKEN
          --org $$INFLUXDB_ORG
          --name $$INFLUXDB_BUCKET
          --retention $${RETENTION_SECONDS}s
        || echo "Retention update skipped (bucket may not exist yet)"
        echo "Done."
      '
    restart: "no"

  influxdb:
    image: influxdb:2.7
    container_name: ptt-influxdb
    ports:
      - "8086:8086"
    volumes:
      - influxdb-data:/var/lib/influxdb2
    environment:
      DOCKER_INFLUXDB_INIT_MODE: setup
      DOCKER_INFLUXDB_INIT_USERNAME: admin
      DOCKER_INFLUXDB_INIT_PASSWORD: ${INFLUXDB_ADMIN_PASSWORD:-ptt-sentiment-2026}
      DOCKER_INFLUXDB_INIT_ORG: ${INFLUXDB_ORG:-ptt-lab}
      DOCKER_INFLUXDB_INIT_BUCKET: ${INFLUXDB_BUCKET:-ptt_sentiment}
      DOCKER_INFLUXDB_INIT_ADMIN_TOKEN: ${INFLUXDB_TOKEN:-ptt-dev-token}
      DOCKER_INFLUXDB_INIT_RETENTION: ${INFLUXDB_RETENTION_DAYS:-90}d

  grafana:
    image: grafana/grafana:11.0.0
    container_name: ptt-grafana
    ports:
      - "3000:3000"
    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning
      - ./grafana/dashboards:/var/lib/grafana/dashboards
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: ${GF_SECURITY_ADMIN_PASSWORD:-admin}
      GF_UNIFIED_ALERTING_ENABLED: "true"
    depends_on:
      - influxdb

volumes:
  influxdb-data:
  grafana-data:
