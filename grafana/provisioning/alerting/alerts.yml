# Grafana Unified Alerting — file-based provisioning
# 兩個告警規則: Buzz Z-score 異常 + 極度貪婪

apiVersion: 1

groups:
  - orgId: 1
    name: "Signals & Sentiment Alerts"
    folder: "Alerts"
    interval: "5m"
    rules:
      # 1. Buzz Z-score > 3: 個股異常飆升警告
      - uid: buzz-zscore-alert
        title: "Buzz Z-score > 3 (Pump-and-Dump Warning)"
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 600  # 10 min
              to: 0
            datasourceUid: influxdb
            model:
              refId: A
              query: |
                from(bucket: "ptt_sentiment")
                  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)
                  |> filter(fn: (r) => r._measurement == "ticker_buzz")
                  |> filter(fn: (r) => r._field == "buzz_score")
                  |> filter(fn: (r) => r._value >= 3.0)
                  |> last()
          - refId: B
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              type: reduce
              refId: B
              expression: A
              reducer: max
              settings:
                mode: dropNN
          - refId: C
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              type: threshold
              refId: C
              expression: B
              conditions:
                - evaluator:
                    type: gt
                    params: [3.0]
        noDataState: OK
        execErrState: Error
        for: "0s"
        annotations:
          summary: "Ticker buzz Z-score > 3 detected — potential pump-and-dump"
          description: "One or more tickers have abnormal discussion volume (Z-score > 3). Check the Buzz Anomaly panel."
        labels:
          severity: warning

      # 2. Extreme Greed: 歐印文比例 >= 15%
      - uid: extreme-greed-alert
        title: "Extreme Greed (歐印文 >= 15%)"
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: influxdb
            model:
              refId: A
              query: |
                from(bucket: "ptt_sentiment")
                  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)
                  |> filter(fn: (r) => r._measurement == "contrarian_index")
                  |> filter(fn: (r) => r._field == "euphoria_ratio")
                  |> last()
          - refId: B
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              type: reduce
              refId: B
              expression: A
              reducer: last
              settings:
                mode: dropNN
          - refId: C
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              type: threshold
              refId: C
              expression: B
              conditions:
                - evaluator:
                    type: gt
                    params: [0.15]
        noDataState: OK
        execErrState: Error
        for: "0s"
        annotations:
          summary: "Extreme Greed detected — euphoria ratio >= 15%"
          description: "歐印文占比 >= 15%，市場可能過熱。Check the Fear & Greed gauge."
        labels:
          severity: warning
